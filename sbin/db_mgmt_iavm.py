#!/usr/bin/env python3
#
# Import script for DISA IAVM to CVE mapping data
#
# The format is the following:
# {'_id' : ObjectId('602529c53525419a92b42741'), 'severity': 'CAT I',
#  'id': '140183', 'number': '2016-A-0023', 'cve': [
#  'CVE-2015-7575', 'CVE-2015-8126', 'CVE-2016-0402', 'CVE-2016-0448',
#  'CVE-2016-0466', 'CVE-2016-0475', 'CVE-2016-0483', 'CVE-2016-0494',
#  'CVE-2016-0603', 'CVE-2016-0636'], 'title': 'Multiple Vulnerabilities
#  in Oracle Java SE'}
#
# Copyright (c) 2013-2014 	Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2015 		Pieter-Jan Moreels - pieterjan.moreels@gmail.com
# Copyright (c) 2016            Nathanael I Burton - nathanael.i.burton@gmail.com

# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

from xml.sax import make_parser
from xml.sax.handler import ContentHandler
import argparse
import zipfile
import tempfile

from lib.ProgressBar import progressbar
from lib.Config import Configuration
import lib.DatabaseLayer as db

argparser = argparse.ArgumentParser(description='populate/update DISA IAVM to CVE mapping')
argparser.add_argument('-v', action='store_true', help='verbose output')
args = argparser.parse_args()

class IAVMHandler(ContentHandler):
    def __init__(self):
        self.iavm = []
        self.tag_notice = False
        self.tag_cve = False

    def startElement(self, name, attrs):
        if name == 'notice':
            self.tag_notice = True
            self.notice_id = attrs.get('id')
            self.number = attrs.get('number')
            self.severity = attrs.get('severity')
            self.title = attrs.get('title')
            self.iavm.append({'id': self.notice_id, 'number': self.number, 'severity': self.severity, 'title': self.title})
        elif name == 'cvelist':
            self.tag_cvelist = True
            self.cvelist = []
        elif name == 'cve':
            self.tag_cve = True
            self.cve = ""

    def characters(self, ch):
        if self.tag_cve:
            self.cve += ch

    def endElement(self, name):
        if name == 'cve':
            self.tag_cve = False
            self.cvelist.append(self.cve)
        if name == 'cvelist':
            self.tag_cvelist = False
            self.iavm[-1]['cve'] = self.cvelist
        elif name == 'notice':
            self.tag_notice = False

# dictionary
iavmdict = Configuration.getIAVMDict()

# make parser
parser = make_parser()
ch = IAVMHandler()
parser.setContentHandler(ch)

try:
    f = Configuration.getFile(iavmdict)
except:
    sys.exit("Cannot open url %s. Bad URL or not connected to the internet?"%(iavmdict))
i = db.getLastModified("iavm")

# check modification date
lastmodified = f.headers['last-modified']
if i is not None:
    if f.headers['last-modified'] == i:
        print("Not modified")
        sys.exit(0)

# parse xml and store in database
parser.parse(f)
iavmList=[]
for iavm in progressbar(ch.iavm):
    if args.v:
        print (iavm)
    iavmList.append(iavm)
db.bulkUpdate('iavm', iavmList)

#update database info after successful program-run
db.setColUpdate('iavm', lastmodified)
